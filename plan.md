# ä»»åŠ¡å¤æ‚åº¦æ‰‹åŠ¨é€‰æ‹©åŠŸèƒ½ - å®æ–½å®Œæˆ

## åŠŸèƒ½æ¦‚è¿°

åœ¨äº¤äº’èœå•ä¸­å¢åŠ "ä»»åŠ¡å¤æ‚åº¦"é€‰æ‹©ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æŒ‡å®šï¼š

- **ç®€å•ä»»åŠ¡ (MINIMAL)**: developer + testerï¼ˆ2ä¸ªagentsï¼Œå¿«é€Ÿæ‰§è¡Œï¼‰
- **å¤æ‚ä»»åŠ¡ (COMPLEX)**: å…¨éƒ¨6ä¸ªagentsï¼ˆarchitect â†’ tech_lead â†’ developer â†’ tester â†’ optimizer â†’ securityï¼‰

**æ–°èœå•æµç¨‹ï¼š**
1. é€‰æ‹©æ‰§è¡Œæ¨¡å¼ (1/2/3/4/5)
2. é€‰æ‹©è¿­ä»£è½®æ•° (1/2/3)
3. **é€‰æ‹©ä»»åŠ¡å¤æ‚åº¦ (ç®€å•/å¤æ‚)** â† æ–°å¢

---

## å·²å®Œæˆçš„ä¿®æ”¹

### ä¿®æ”¹1: æ‰©å±• TaskComplexity æšä¸¾ âœ…

**ä½ç½®:** src/6-agents.py:47-52

**ä¿®æ”¹å†…å®¹:**
```python
class TaskComplexity(Enum):
    MINIMAL = "minimal"      # 2ä¸ªagents (developer + tester) â† æ–°å¢
    SIMPLE = "simple"        # 3ä¸ªagents (architect â†’ developer â†’ tester)
    MODERATE = "moderate"    # 4-5ä¸ªagents
    COMPLEX = "complex"      # 6ä¸ªagents (å…¨æµç¨‹)
```

### ä¿®æ”¹2: æ›´æ–° AgentScheduler.plan_execution() âœ…

**ä½ç½®:** src/6-agents.py:224-250

**æ–°å¢åˆ†æ”¯:**
```python
if complexity == TaskComplexity.MINIMAL:
    return [
        ["developer"],
        ["tester"]
    ]
```

### ä¿®æ”¹3: æ–°å¢ _ask_task_complexity() å‡½æ•° âœ…

**ä½ç½®:** src/6-agents.py:~2475ï¼ˆ_ask_max_roundsä¹‹åï¼‰

**åŠŸèƒ½:**
- è¯¢é—®ç”¨æˆ·é€‰æ‹©ä»»åŠ¡å¤æ‚åº¦
- è¿”å› TaskComplexity.MINIMAL æˆ– TaskComplexity.COMPLEX

### ä¿®æ”¹4: execute() æ”¯æŒå¤æ‚åº¦è¦†ç›– âœ…

**ä½ç½®:** src/6-agents.py:1202-1235

**æ–°å¢å‚æ•°:**
```python
async def execute(
    self,
    user_request: str,
    clean_start: bool = True,
    override_complexity: Optional[TaskComplexity] = None  # æ–°å¢
) -> bool:
```

**é€»è¾‘:**
- å¦‚æœæä¾› override_complexityï¼Œä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„å¤æ‚åº¦
- å¦åˆ™ï¼Œä½¿ç”¨ TaskParser è‡ªåŠ¨è§£æ

### ä¿®æ”¹5: execute_with_loop() æ”¯æŒå¤æ‚åº¦è¦†ç›– âœ…

**ä½ç½®:** src/6-agents.py:1842-1880

**åŒæ­¥ä¿®æ”¹:**
- æ·»åŠ  override_complexity å‚æ•°
- å®ç°ä¸ execute() ç›¸åŒçš„å¤æ‚åº¦å¤„ç†é€»è¾‘

### ä¿®æ”¹6: æ›´æ–° interactive_mode() âœ…

**ä½ç½®:** src/6-agents.py:2540-2610

**ä¿®æ”¹å†…å®¹:**
1. åœ¨è¯¢é—®è¿­ä»£è½®æ•°åï¼Œè°ƒç”¨ `_ask_task_complexity()`
2. æ˜¾ç¤ºé€‰æ‹©ç»“æœ
3. å°†å¤æ‚åº¦ä¼ é€’ç»™ execute/execute_with_loop
4. å¯¹æ¨¡å¼1/2æ·»åŠ æç¤ºï¼ˆå¤æ‚åº¦è®¾ç½®ä¼šè¢«å¿½ç•¥ï¼‰

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|----------|------|
| src/6-agents.py | æ‰©å±• TaskComplexity æšä¸¾ | +1 |
| src/6-agents.py | æ›´æ–° plan_execution() | +4 |
| src/6-agents.py | æ–°å¢ _ask_task_complexity() | +14 |
| src/6-agents.py | ä¿®æ”¹ execute() | +8 |
| src/6-agents.py | ä¿®æ”¹ execute_with_loop() | +7 |
| src/6-agents.py | æ›´æ–° interactive_mode() | +20 |

**æ€»è®¡:** ~54è¡Œæ–°å¢/ä¿®æ”¹

---

## æµ‹è¯•ç»“æœ

### è¯­æ³•æ£€æŸ¥ âœ…
```bash
python -m py_compile src/6-agents.py
# é€šè¿‡
```

### å•å…ƒæµ‹è¯• âœ…
```bash
pytest tests/ -v
# 61 passed in 1.29s
```

### åŠŸèƒ½éªŒè¯

#### æµ‹è¯•åœºæ™¯1ï¼šç®€å•ä»»åŠ¡ + MINIMAL

```bash
python src/6-agents.py
# é€‰æ‹©ï¼š3ï¼ˆå…¨è‡ªåŠ¨æ¨¡å¼ï¼‰
# è¿­ä»£è½®æ•°ï¼š1
# ä»»åŠ¡å¤æ‚åº¦ï¼š1ï¼ˆç®€å•ä»»åŠ¡ï¼‰
# è¾“å…¥ï¼š"ä¿®å¤ main.py ä¸­çš„æ‹¼å†™é”™è¯¯"

é¢„æœŸç»“æœï¼š
âœ“ åªæ‰§è¡Œ developer + tester
âœ“ è·³è¿‡ architect, tech_lead, optimizer, security
âœ“ å¿«é€Ÿå®Œæˆ
```

#### æµ‹è¯•åœºæ™¯2ï¼šå¤æ‚ä»»åŠ¡ + COMPLEX + å¤šè½®

```bash
python src/6-agents.py
# é€‰æ‹©ï¼š3ï¼ˆå…¨è‡ªåŠ¨æ¨¡å¼ï¼‰
# è¿­ä»£è½®æ•°ï¼š2
# ä»»åŠ¡å¤æ‚åº¦ï¼š2ï¼ˆå¤æ‚ä»»åŠ¡ï¼‰
# è¾“å…¥ï¼š"å¼€å‘ä¸€ä¸ªè®¡ç®—å™¨ç¨‹åº"

é¢„æœŸç»“æœï¼š
âœ“ æ‰§è¡Œå…¨éƒ¨6ä¸ªagents
âœ“ developer-tester æœ€å¤šå¾ªç¯2è½®
```

#### æµ‹è¯•åœºæ™¯3ï¼šåŠè‡ªåŠ¨æ¨¡å¼ï¼ˆæç¤ºç”¨æˆ·ï¼‰

```bash
python src/6-agents.py
# é€‰æ‹©ï¼š1ï¼ˆåŠè‡ªåŠ¨æ¨¡å¼ï¼‰
# è¿­ä»£è½®æ•°ï¼š1
# ä»»åŠ¡å¤æ‚åº¦ï¼š1ï¼ˆç®€å•ä»»åŠ¡ï¼‰

é¢„æœŸç»“æœï¼š
âš ï¸ æ˜¾ç¤ºæç¤ºï¼š"åŠè‡ªåŠ¨æ¨¡å¼ä¼šç”± Architect è‡ªåŠ¨è§„åˆ’ï¼Œå¤æ‚åº¦è®¾ç½®å°†è¢«å¿½ç•¥"
âœ“ æ­£å¸¸è¿›å…¥ Claude CLI
```

---

## æ–°èœå•ç¤ºä¾‹

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       ğŸš€ mc-dir - å¤šAgentæ™ºèƒ½è°ƒåº¦ç³»ç»Ÿ                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é€‰æ‹©æ‰§è¡Œæ¨¡å¼ï¼š
  1. åŠè‡ªåŠ¨æ¨¡å¼ï¼ˆæ¨èï¼‰- è¿›å…¥ Claude CLI è®¨è®ºéœ€æ±‚ï¼Œç”Ÿæˆ PLAN.md åè‡ªåŠ¨æ‰§è¡Œ
  2. ä» PLAN.md ç»§ç»­ - è·³è¿‡ Architectï¼Œç›´æ¥ä»ç°æœ‰è®¡åˆ’æ‰§è¡Œï¼ˆèŠ‚çœ tokenï¼‰
  3. å…¨è‡ªåŠ¨æ¨¡å¼ - è¾“å…¥ä»»åŠ¡åï¼ŒArchitect è‡ªåŠ¨è§„åˆ’å¹¶æ‰§è¡Œå…¨æµç¨‹
  4. ï¼ˆADVï¼‰å¤šagentæ¨¡å¼* - å¯åŒæ—¶æŒ‡æ´¾å¤šå AgentsğŸš€ğŸš€ğŸš€
  5. é€€å‡º

è¯·é€‰æ‹© [1/2/3/4/5]: 3

å¼€å‘-æµ‹è¯•è¿­ä»£è½®æ•°ï¼š
  1. 1è½®ï¼ˆé»˜è®¤ï¼‰- çº¿æ€§æ‰§è¡Œï¼Œä¸å¾ªç¯
  2. 2è½® - å¦‚æœ‰bugï¼Œdeveloper-testerå†è¿­ä»£1æ¬¡
  3. 3è½® - æœ€å¤šè¿­ä»£3æ¬¡

è¯·é€‰æ‹© [1/2/3ï¼Œç›´æ¥å›è½¦=1]: 1
âœ“ å·²è®¾ç½®: æœ€å¤š 1 è½® developer-tester è¿­ä»£

ä»»åŠ¡å¤æ‚åº¦ï¼š
  1. ç®€å•ä»»åŠ¡ - åªç”¨ developer + testerï¼ˆ2ä¸ªagentsï¼Œå¿«é€Ÿæ‰§è¡Œï¼‰
  2. å¤æ‚ä»»åŠ¡ - å®Œæ•´æµç¨‹ï¼ˆ6ä¸ªagentsï¼Œå…¨é¢ä¿éšœï¼‰

è¯·é€‰æ‹© [1/2ï¼Œç›´æ¥å›è½¦=2]: 1
âœ“ å·²è®¾ç½®: ç®€å•ä»»åŠ¡ï¼ˆ2ä¸ªagentsï¼‰

è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆæˆ– .md æ–‡ä»¶è·¯å¾„ï¼‰ï¼š
> ä¿®å¤æ‹¼å†™é”™è¯¯

ğŸš€ å…¨è‡ªåŠ¨æ¨¡å¼å¯åŠ¨...
ğŸ“‹ ç”¨æˆ·éœ€æ±‚: ä¿®å¤æ‹¼å†™é”™è¯¯
ä»»åŠ¡å¤æ‚åº¦: minimalï¼ˆç”¨æˆ·æŒ‡å®šï¼‰
æ‰§è¡Œè®¡åˆ’: 2 ä¸ªé˜¶æ®µ

Phase 1: developer
Phase 2: tester
```

---

## ä¸ç°æœ‰åŠŸèƒ½çš„å…¼å®¹æ€§

### å‘åå…¼å®¹ âœ…
- `execute()` å’Œ `execute_with_loop()` çš„ `override_complexity` å‚æ•°ä¸º**å¯é€‰**
- ä¸ä¼ è¯¥å‚æ•°æ—¶ï¼Œä¿æŒåŸæœ‰çš„è‡ªåŠ¨è§£æè¡Œä¸º
- CLI å‚æ•°ä»ç„¶å¯ç”¨ï¼ˆ`--auto-architect`, `--max-rounds` ç­‰ï¼‰

### å¤æ‚åº¦ä¼˜å…ˆçº§
1. **ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©** (override_complexity) â†’ æœ€é«˜ä¼˜å…ˆçº§
2. **è‡ªåŠ¨è§£æ** (TaskParser.parse) â†’ é»˜è®¤è¡Œä¸º

### ç‰¹æ®Šæ¨¡å¼å¤„ç†
- **æ¨¡å¼1ï¼ˆåŠè‡ªåŠ¨ï¼‰**: å¤æ‚åº¦é€‰æ‹©è¢«å¿½ç•¥ï¼ˆarchitect è§„åˆ’ï¼‰
- **æ¨¡å¼2ï¼ˆä»PLAN.mdç»§ç»­ï¼‰**: å¤æ‚åº¦é€‰æ‹©è¢«å¿½ç•¥ï¼ˆå·²æœ‰è®¡åˆ’ï¼‰
- **æ¨¡å¼3ï¼ˆå…¨è‡ªåŠ¨ï¼‰**: å¤æ‚åº¦é€‰æ‹©ç”Ÿæ•ˆ
- **æ¨¡å¼4ï¼ˆå¤šagentæ¨¡å¼*ï¼‰**: ä¸è¯¢é—®å¤æ‚åº¦

---

## å¤æ‚åº¦å¯¹æ¯”è¡¨

| å¤æ‚åº¦ | Agentsæ•°é‡ | æ‰§è¡Œæµç¨‹ | é€‚ç”¨åœºæ™¯ |
|--------|-----------|----------|---------|
| MINIMAL | 2ä¸ª | developer â†’ tester | æ‹¼å†™é”™è¯¯ã€ç®€å•bugä¿®å¤ |
| SIMPLE | 3ä¸ª | architect â†’ developer â†’ tester | å°åŠŸèƒ½æ·»åŠ  |
| MODERATE | 4-5ä¸ª | architect â†’ developer â†’ (tester + security) | ä¸­ç­‰åŠŸèƒ½ |
| COMPLEX | 6ä¸ª | architect â†’ tech_lead â†’ developer â†’ (tester + security + optimizer) | å¤§å‹åŠŸèƒ½ã€ç³»ç»Ÿé‡æ„ |

---

## æ€»ç»“

- âœ… æ–°å¢ MINIMAL å¤æ‚åº¦é€‰é¡¹ï¼ˆ2ä¸ªagentsï¼‰
- âœ… åœ¨äº¤äº’èœå•ä¸­æ·»åŠ ç¬¬3ä¸ªé€‰é¡¹ï¼šä»»åŠ¡å¤æ‚åº¦
- âœ… æ”¯æŒç”¨æˆ·æ‰‹åŠ¨è¦†ç›–è‡ªåŠ¨è§£æ
- âœ… 61ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… ä»£ç è´¨é‡ï¼šè¯­æ³•æ£€æŸ¥é€šè¿‡

**é¢„è®¡æå‡ï¼š**
- ç®€å•ä»»åŠ¡æ‰§è¡Œé€Ÿåº¦æå‡ ~60%ï¼ˆ6ä¸ªagents â†’ 2ä¸ªagentsï¼‰
- Tokenæ¶ˆè€—å‡å°‘ ~70%
- ç”¨æˆ·æ§åˆ¶åŠ›å¢å¼º

---

# 2026-02-05 å¤œé—´ Bug ä¿®å¤

## æœ¬æ¬¡ä¿®å¤çš„ Bug åˆ—è¡¨

| Bug | æè¿° | çŠ¶æ€ |
|-----|------|------|
| Bug 0 | `execute_with_loop()` ä¸­ branch å‘½åé”™è¯¯ï¼ˆç¼ºå°‘ first_agent å‚æ•°ï¼‰ | âœ… å·²ä¿®å¤ |
| Bug 1 | åŠè‡ªåŠ¨æ¨¡å¼"æ‰¹å‡†è®¡åˆ’åç›´æ¥æ‰§è¡Œ"ï¼ˆç”¨æˆ·æ— æ³•ç¼–è¾‘ PLAN.mdï¼‰ | âœ… å·²ä¿®å¤ |
| Bug 2 | å¤š Agent å¹¶è¡Œæ‰§è¡Œæ–‡ä»¶å†²çªï¼ˆæ— éš”ç¦»æœºåˆ¶ï¼‰ | âœ… å·²ä¿®å¤ |

---

## Bug 0: Branch å‘½åä¿®å¤

### é—®é¢˜æè¿°

**ä½ç½®:** `src/6-agents.py` ç¬¬ 1890 è¡Œï¼ˆåŸï¼‰

**é—®é¢˜:** `execute_with_loop()` è°ƒç”¨ `_create_feature_branch(user_request)` æ—¶ç¼ºå°‘ `first_agent` å‚æ•°ï¼Œå¯¼è‡´ MINIMAL å¤æ‚åº¦ä¸‹ branch å‘½åé”™è¯¯ã€‚

| å¤æ‚åº¦ | é¦–ä¸ª Agent | ä¿®å¤å‰ Branch | ä¿®å¤å Branch |
|--------|-----------|--------------|--------------|
| MINIMAL | developer | feature/arch-XXX âŒ | feature/dev-XXX âœ… |
| SIMPLE | architect | feature/arch-XXX âœ… | feature/arch-XXX âœ… |

### ä¿®å¤å†…å®¹

```python
# ä¿®å¤å‰
feature_branch = self._create_feature_branch(user_request)

# ä¿®å¤å
first_agent = phases[0][0] if phases and phases[0] else "arch"
feature_branch = self._create_feature_branch(user_request, first_agent)
```

---

## Bug 1: åŠè‡ªåŠ¨æ¨¡å¼ä¸¤é˜¶æ®µç¡®è®¤

### é—®é¢˜æè¿°

**ä½ç½®:** `src/6-agents.py` `semi_auto_mode()` å‡½æ•°

**é—®é¢˜:** ç”¨æˆ·æŒ‰ Y ç¡®è®¤åï¼Œç›´æ¥æ‰§è¡Œåç»­ agentsï¼Œæ— æ³•ä¿®æ”¹ PLAN.mdã€‚

### ä¿®å¤æ–¹æ¡ˆï¼šä¸¤é˜¶æ®µç¡®è®¤

**æ–°æµç¨‹:**
```
æ˜¾ç¤º PLAN.md é¢„è§ˆ â†’ æ˜¯å¦æŸ¥çœ‹/ç¼–è¾‘ï¼Ÿ[Y/n/q]
  â†’ Y: æ‰“å¼€ç¼–è¾‘å™¨ â†’ æ˜¾ç¤ºæ›´æ–°é¢„è§ˆ
  â†’ n: è·³è¿‡ç¼–è¾‘
  â†’ q: é€€å‡ºï¼ˆå¯ç”¨æ¨¡å¼2ç»§ç»­ï¼‰
â†’ ç¡®è®¤æ‰§è¡Œï¼Ÿ[Y/n] â†’ æ‰§è¡Œ
```

### æ–°å¢ä»£ç 

1. **æ–°å¢è¾…åŠ©å‡½æ•°** `_open_file_in_editor()` (~ç¬¬ 2255 è¡Œ)
   - è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/Macï¼‰
   - Windows: `start /wait` æˆ– notepad
   - Linux/Mac: `$EDITOR` æˆ– nano/vim

2. **ä¿®æ”¹ç¡®è®¤é€»è¾‘** (~ç¬¬ 2408 è¡Œ)
   - é˜¶æ®µ1: è¯¢é—®æ˜¯å¦ç¼–è¾‘ PLAN.mdï¼ˆY/n/qï¼‰
   - é˜¶æ®µ2: æœ€ç»ˆæ‰§è¡Œç¡®è®¤

---

## Bug 2: å¤š Agent å¹¶è¡Œå­åˆ†æ”¯éš”ç¦»

### é—®é¢˜æè¿°

**ä½ç½®:** `src/6-agents.py` å¹¶è¡Œæ‰§è¡Œé€»è¾‘
- `execute()` ç¬¬ 1485 è¡Œï¼ˆåŸï¼‰
- `execute_manual()` ç¬¬ 2325 è¡Œï¼ˆåŸï¼‰

**é—®é¢˜:** å¹¶è¡Œ agents åœ¨åŒä¸€ä¸ª feature branch ä¸Šå·¥ä½œï¼Œå¯èƒ½äº’ç›¸è¦†ç›–æ–‡ä»¶ã€‚

### ä¿®å¤æ–¹æ¡ˆï¼šå­åˆ†æ”¯éš”ç¦»

**æ–°æµç¨‹:**
```
feature/dev-001           â† ä¸» feature åˆ†æ”¯
â”œâ”€â”€ feature/dev-001-developer-abc123   â† developer éš”ç¦»åˆ†æ”¯
â””â”€â”€ feature/dev-001-optimizer-def456   â† optimizer éš”ç¦»åˆ†æ”¯

æ‰§è¡Œå®Œæˆ â†’ ä¾æ¬¡åˆå¹¶ â†’ æ£€æµ‹å†²çª â†’ å†²çªæ—¶ä¿ç•™åˆ†æ”¯ä¾›æ‰‹åŠ¨å¤„ç†
```

### æ–°å¢ä»£ç 

**5 ä¸ª Git è¾…åŠ©æ–¹æ³•** (~ç¬¬ 1207 è¡Œå):

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `_get_current_branch()` | è·å–å½“å‰åˆ†æ”¯å |
| `_create_agent_subbranch()` | ä¸º agent åˆ›å»ºéš”ç¦»å­åˆ†æ”¯ |
| `_switch_to_branch()` | åˆ‡æ¢åˆ†æ”¯ |
| `_commit_agent_changes()` | æäº¤ agent æ›´æ”¹ |
| `_merge_subbranch()` | åˆå¹¶å­åˆ†æ”¯ï¼ˆå¸¦å†²çªæ£€æµ‹ï¼‰ |
| `_cleanup_subbranch()` | æ¸…ç†å­åˆ†æ”¯ |

**ä¿®æ”¹å¹¶è¡Œæ‰§è¡Œé€»è¾‘:**
- `execute()` å’Œ `execute_manual()` çš„ else åˆ†æ”¯
- ä¸ºæ¯ä¸ªå¹¶è¡Œ agent åˆ›å»ºç‹¬ç«‹å­åˆ†æ”¯
- å®Œæˆåä¾æ¬¡åˆå¹¶ï¼Œæ£€æµ‹å†²çª

---

## æµ‹è¯•ç»“æœ

### è¯­æ³•æ£€æŸ¥ âœ…
```bash
python -m py_compile src/6-agents.py
# é€šè¿‡
```

### å•å…ƒæµ‹è¯• âœ…
```bash
pytest tests/ -v
# 61 passed
```

### ä»£ç æ”¹åŠ¨ç»Ÿè®¡
```
src/6-agents.py | +308 è¡Œ, -12 è¡Œ
```

---

## å¾…åŠŸèƒ½æµ‹è¯•

### Bug 1 æµ‹è¯•ï¼ˆæ¨¡å¼1ï¼‰
```bash
python src/6-agents.py
# é€‰æ‹© 1 (åŠè‡ªåŠ¨æ¨¡å¼)
# ç”Ÿæˆ PLAN.md åï¼Œæµ‹è¯• Y/n/q ä¸‰ä¸ªé€‰é¡¹
```

### Bug 2 æµ‹è¯•ï¼ˆæ¨¡å¼4ï¼‰
```bash
python src/6-agents.py
# é€‰æ‹© 4 (å¤šagentæ¨¡å¼)
# è¾“å…¥: @developer ä¿®å¤A && @optimizer ä¼˜åŒ–B
# è§‚å¯Ÿæ˜¯å¦åˆ›å»ºå­åˆ†æ”¯å¹¶æ­£ç¡®åˆå¹¶
```

---

## å…³é”®ç»éªŒ

1. **Python ç¨‹åºå¯ä»¥ä¿®æ”¹è‡ªå·±** - ä»£ç è¿è¡Œæ—¶å·²åœ¨å†…å­˜ä¸­ï¼Œä¿®æ”¹ç£ç›˜æ–‡ä»¶ä¸å½±å“å½“å‰æ‰§è¡Œ
2. **å­åˆ†æ”¯éš”ç¦»æ˜¯è§£å†³å¹¶è¡Œå†²çªçš„å¯é æ–¹æ¡ˆ** - æ¯”æ–‡ä»¶é”æ›´çµæ´»ï¼Œå†²çªå¯è¿½æº¯
3. **ä¸¤é˜¶æ®µç¡®è®¤æå‡ç”¨æˆ·ä½“éªŒ** - ç»™ç”¨æˆ·å®¡æ ¸/ä¿®æ”¹çš„æœºä¼šï¼Œé¿å…ç›´æ¥æ‰§è¡Œ

---

# 2026-02-06 å››å¤§åŠŸèƒ½æ›´æ–° (mission1.md)

## æœ¬æ¬¡æ–°å¢åŠŸèƒ½åˆ—è¡¨

| Feature | æè¿° | çŠ¶æ€ |
|---------|------|------|
| Feature 1 | è¿›åº¦æ–‡ä»¶ç®¡ç† + ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç† | âœ… å·²å®Œæˆ |
| Feature 2 | ä¼˜åŒ– 01-Agent Repo æ‰«æï¼ˆè¯»å–ç°æœ‰æ‰«æç»“æœï¼‰ | âœ… å·²å®Œæˆ |
| Feature 3 | Hook æœºåˆ¶é™åˆ¶ 01-Agent è¶Šæƒï¼ˆä¸‰é‡ä¿æŠ¤ï¼‰ | âœ… å·²å®Œæˆ |
| Feature 4 | æ‰©å±•æ¨¡å¼4æ”¯æŒ .md æ–‡ä»¶å¼•ç”¨ | âœ… å·²å®Œæˆ |

---

## Feature 1: è¿›åº¦æ–‡ä»¶ç®¡ç†ä¸ä¸´æ—¶æ–‡ä»¶å¤„ç†

### æ–°å¢æ–¹æ³•

| æ–¹æ³• | ä½ç½® | åŠŸèƒ½ |
|------|------|------|
| `_init_progress_file()` | Orchestrator ç±» | åˆ›å»º claude-progress.mdï¼ˆé€’å¢ç¼–å·é¿å…è¦†ç›–ï¼‰ |
| `_cleanup_temp_agent_files()` | Orchestrator ç±» | æ¸…ç† CODEBASE_ANALYSIS.md, BUG_REPORT*.md, SECURITY_AUDIT.md, PROGRESS.md |

### æ–‡ä»¶å‘½åè§„åˆ™

```
claude-progress.md      â† ç¬¬1æ¬¡è¿è¡Œ
claude-progress01.md    â† ç¬¬2æ¬¡è¿è¡Œ
claude-progress02.md    â† ç¬¬3æ¬¡è¿è¡Œ
...
```

### å½±å“èŒƒå›´

- `Orchestrator.__init__()`: æ–°å¢ `self.progress_file` å±æ€§
- `generate_initial_prompt()`: æ–°å¢ `progress_file` å‚æ•°ï¼Œæç¤º Agent æ›´æ–°è¿›åº¦æ–‡ä»¶
- æ‰€æœ‰ `execute*()` æ–¹æ³•ï¼ˆå…±5ä¸ªï¼‰:
  - å¼€å¤´è°ƒç”¨ `_init_progress_file()`
  - ç»“å°¾è°ƒç”¨ `_cleanup_temp_agent_files()` + æ˜¾ç¤ºè¿›åº¦æ–‡ä»¶è·¯å¾„

### ä¸´æ—¶æ–‡ä»¶å¤„ç†ç­–ç•¥

| æ–‡ä»¶ | ç”Ÿå‘½å‘¨æœŸ |
|------|---------|
| `claude-progress*.md` | **æ°¸ä¹…ä¿ç•™**ï¼ˆç”¨æˆ·çš„æŒä¹…è®°å½•ï¼‰ |
| `PLAN.md` | **ä¿ç•™**ï¼ˆå¯èƒ½è¢«æ¨¡å¼2å¤ç”¨ï¼‰ |
| `CODEBASE_ANALYSIS.md` | å·¥ä½œæµç»“æŸæ—¶æ¸…ç† |
| `BUG_REPORT.md` / `BUG_REPORT_round*.md` | å·¥ä½œæµç»“æŸæ—¶æ¸…ç† |
| `SECURITY_AUDIT.md` | å·¥ä½œæµç»“æŸæ—¶æ¸…ç† |
| `PROGRESS.md`ï¼ˆagent ç”Ÿæˆï¼‰ | å·¥ä½œæµç»“æŸæ—¶æ¸…ç† |

---

## Feature 2: ä¼˜åŒ– 01-Agent Repo æ‰«æ

### ä¿®æ”¹ä½ç½®

`TaskParser.generate_initial_prompt()` â€” architect + ç°æœ‰é¡¹ç›®åˆ†æ”¯

### å·¥ä½œé€»è¾‘

```
if repo-scan-result.md å­˜åœ¨:
    â†’ è¯»å–å†…å®¹ï¼ˆæˆªå–å‰3000å­—ç¬¦ï¼‰æ³¨å…¥ architect prompt
    â†’ è·³è¿‡"ä»£ç åº“åˆ†æ"æ­¥éª¤ï¼Œç›´æ¥åˆ¶å®š PLAN.md
else:
    â†’ èµ°åŸæµç¨‹ï¼šarchitect å…¨é‡æ‰«æä»£ç åº“ â†’ ç”Ÿæˆ CODEBASE_ANALYSIS.md â†’ åˆ¶å®š PLAN.md
```

### Token èŠ‚çœé¢„ä¼°

- è·³è¿‡ä»£ç åº“æ‰«æå¯èŠ‚çœ architect é˜¶æ®µçº¦ 30-50% çš„ token
- ç”¨æˆ·å¯ç”¨å¤–éƒ¨ LLMï¼ˆGrok/GPT/Geminiï¼‰ç”Ÿæˆ `repo-scan-result.md`ï¼Œè¿›ä¸€æ­¥é™ä½ Claude token æ¶ˆè€—

---

## Feature 3: Hook æœºåˆ¶é™åˆ¶ 01-Agent è¶Šæƒ

### é—®é¢˜èƒŒæ™¯

å°½ç®¡ architect å·²ä½¿ç”¨ `--permission-mode plan`ï¼Œç‰¹å®š promptï¼ˆå¦‚"å¯¹ä»£ç è¿›è¡Œå…¨é¢æµ‹è¯•å’Œdebug"ï¼‰ä»å¯èƒ½å¯¼è‡´å®ƒç›´æ¥ä¿®æ”¹æºä»£ç ã€‚

### ä¸‰é‡ä¿æŠ¤æœºåˆ¶

**ç¬¬ä¸€å±‚ï¼šPrompt å¼ºåŒ–ï¼ˆé¢„é˜²ï¼‰**

- ä½ç½®: `AgentExecutor.run_agent()`
- å½“ `config.name == "architect"` æ—¶ï¼Œè‡ªåŠ¨è¿½åŠ æƒé™é™åˆ¶è¯´æ˜åˆ° `task_prompt`
- æ˜ç¡®åˆ—å‡ºå…è®¸å’Œç¦æ­¢çš„æ“ä½œï¼Œå¹¶è­¦å‘Š"è¿åå°†è¢«å›æ»š"

**ç¬¬äºŒå±‚ï¼šå®æ—¶æµç›‘æ§ï¼ˆå³æ—¶æ‹¦æˆªï¼‰** â† æ–°å¢

- ä½ç½®: `AgentExecutor._monitor_architect_stream()` + `_check_architect_violation()`
- åŸç†: architect ä½¿ç”¨ `--output-format stream-json`ï¼Œé€è¡Œè¯»å– stdout æµ
- æ£€æµ‹: è§£ææ¯è¡Œ JSONï¼ŒåŒ¹é… `Write`/`Edit` å·¥å…·è°ƒç”¨ä¸­çš„ `file_path` å­—æ®µ
- æ‹¦æˆª: ä¸€æ—¦å‘ç°ç›®æ ‡æ–‡ä»¶é `.md`ï¼Œç«‹å³ `process.kill()` ç»ˆæ­¢è¿›ç¨‹
- è¿”å›: `AgentStatus.FAILED`ï¼Œ`exit_code=-2`ï¼ˆè¶Šæƒä¸“ç”¨é”™è¯¯ç ï¼‰

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `_check_architect_violation(line)` | è§£æå•è¡Œ stream-jsonï¼Œæ£€æµ‹æ˜¯å¦æœ‰å¯¹é .md æ–‡ä»¶çš„ Write/Edit æ“ä½œ |
| `_monitor_architect_stream(process)` | é€è¡Œè¯»å– architect stdoutï¼Œè°ƒç”¨ violation æ£€æŸ¥å™¨ï¼Œå‘ç°è¿è§„ç«‹å³ kill |

**ä¼˜åŠ¿**: ç›¸æ¯”åç½®æ ¡éªŒï¼Œå®æ—¶ç›‘æ§å¯åœ¨ architect å°è¯•å†™å…¥ç¬¬ä¸€ä¸ªé .md æ–‡ä»¶æ—¶ç«‹å³ç»ˆæ­¢ï¼ŒèŠ‚çœåç»­æ‰€æœ‰ token æ¶ˆè€—å’Œæ‰§è¡Œæ—¶é—´ã€‚

**ç¬¬ä¸‰å±‚ï¼šåç½®æ ¡éªŒ + è‡ªåŠ¨å›æ»šï¼ˆå…œåº•ï¼‰**

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `_validate_architect_output()` | æ‰§è¡Œ `git diff --name-only` + `git ls-files --others`ï¼Œæ£€æµ‹é .md æ–‡ä»¶å˜æ›´ |
| `_rollback_architect_violations()` | `git checkout --` è¿˜åŸå·²ä¿®æ”¹æ–‡ä»¶ + `unlink()` åˆ é™¤æ–°åˆ›å»ºçš„é .md æ–‡ä»¶ |

> å³ä½¿ç¬¬äºŒå±‚å®æ—¶ç›‘æ§å·²æ‹¦æˆªè¿›ç¨‹ï¼Œç¬¬ä¸‰å±‚ä»ç„¶æ‰§è¡Œï¼Œç¡®ä¿åœ¨ kill ä¹‹å‰å·²å†™å…¥çš„æ–‡ä»¶è¢«æ­£ç¡®å›æ»šã€‚

### æ ¡éªŒè§¦å‘ç‚¹

åœ¨ä»¥ä¸‹æ–¹æ³•ä¸­ architect æ‰§è¡Œå®Œæˆåè‡ªåŠ¨è°ƒç”¨ï¼š
- `execute()` â€” å…¨è‡ªåŠ¨æ¨¡å¼
- `execute_with_loop()` â€” å¤šè½®å¾ªç¯æ¨¡å¼
- `execute_manual()` â€” æ‰‹åŠ¨æ¨¡å¼ï¼ˆå¦‚æœæ‰‹åŠ¨æŒ‡å®šäº† @architectï¼‰

### å…¸å‹æ‹¦æˆªæµç¨‹

```
Architect å¯åŠ¨ â†’ stream-json é€è¡Œè¯»å–
  â”œâ”€ {"type":"tool_use","tool":"Read","file_path":"src/main.py"} â†’ âœ… å…è®¸ï¼ˆRead ä¸æ£€æµ‹ï¼‰
  â”œâ”€ {"type":"tool_use","tool":"Write","file_path":"PLAN.md"} â†’ âœ… å…è®¸ï¼ˆ.md æ–‡ä»¶ï¼‰
  â”œâ”€ {"type":"tool_use","tool":"Edit","file_path":"src/main.py"} â†’ ğŸš« è¿è§„ï¼
  â”‚     â†’ process.kill() â†’ è¾“å‡ºè­¦å‘Š â†’ è¿”å› FAILED (exit_code=-2)
  â””â”€ åç½®æ ¡éªŒ â†’ git checkout å›æ»š src/main.py
```

---

## Feature 4: æ‰©å±•æ¨¡å¼4æ”¯æŒ .md æ–‡ä»¶å¼•ç”¨

### ä¿®æ”¹ä½ç½®

`ManualTaskParser` ç±»

### æ”¹åŠ¨å†…å®¹

1. `__init__()`: æ–°å¢ `project_root` å‚æ•°ï¼ˆé»˜è®¤ `Path.cwd()`ï¼‰
2. `parse()`: æ£€æµ‹ä»»åŠ¡æè¿°æ˜¯å¦ä»¥ `.md` ç»“å°¾ï¼Œæ˜¯åˆ™è¯»å–æ–‡ä»¶å†…å®¹ä½œä¸ºä»»åŠ¡æè¿°
3. `interactive_mode()`: `ManualTaskParser()` â†’ `ManualTaskParser(project_root)`
4. å¸®åŠ©æ–‡æœ¬æ–°å¢ `.md` æ–‡ä»¶å¼•ç”¨ç¤ºä¾‹

### ä½¿ç”¨ç¤ºä¾‹

```
# ç›´æ¥æè¿°
@dev ä¿®å¤ç™»å½•é¡µCSS bug

# ä» md æ–‡ä»¶è¯»å–ï¼ˆæ–°åŠŸèƒ½ï¼‰
@dev task-fix-css.md

# å¤š agent + md æ–‡ä»¶ï¼ˆå¹¶è¡Œï¼‰
@dev task1.md && @opti task2.md

# ä¸²è¡Œ + md æ–‡ä»¶æ··åˆ
@arch design.md -> @dev implement.md -> @test test-plan.md
```

### é”™è¯¯å¤„ç†

- æ–‡ä»¶ä¸å­˜åœ¨: `âŒ æ–‡ä»¶ä¸å­˜åœ¨: task1.md` + æ˜¾ç¤ºå®Œæ•´è·¯å¾„
- æ–‡ä»¶è¯»å–å¤±è´¥: `âš ï¸ æ— æ³•è¯»å– task1.md: [é”™è¯¯ä¿¡æ¯]`

---

## æµ‹è¯•ç»“æœ

### è¯­æ³•æ£€æŸ¥ âœ…
```bash
python -m py_compile src/6-agents.py
# é€šè¿‡
```

### å•å…ƒæµ‹è¯• âœ…
```bash
pytest tests/ -v
# 61 passed in 1.13s
```

### ä»£ç æ”¹åŠ¨ç»Ÿè®¡
```
src/6-agents.py | +220 è¡Œ, -15 è¡Œ
```

---

## åŠŸèƒ½æµ‹è¯•åœºæ™¯

### Feature 1 æµ‹è¯•
```bash
python src/6-agents.py
# é€‰æ‹©æ¨¡å¼ 3 â†’ æ£€æŸ¥ claude-progress.md æ˜¯å¦åˆ›å»º
# å†æ¬¡è¿è¡Œ â†’ æ£€æŸ¥ claude-progress01.md æ˜¯å¦åˆ›å»º
# å·¥ä½œæµç»“æŸ â†’ æ£€æŸ¥ CODEBASE_ANALYSIS.md ç­‰ä¸´æ—¶æ–‡ä»¶æ˜¯å¦è¢«æ¸…ç†
```

### Feature 2 æµ‹è¯•
```bash
# åˆ›å»ºæ‰«æç»“æœæ–‡ä»¶
echo "# Repo Scan\n## ç»“æ„\nsrc/main.py - å…¥å£" > repo-scan-result.md
python src/6-agents.py
# é€‰æ‹©æ¨¡å¼ 3 â†’ è§‚å¯Ÿ architect prompt æ˜¯å¦åŒ…å«"å·²æ£€æµ‹åˆ°ä»£ç åº“æ‰«æç»“æœ"
```

### Feature 3 æµ‹è¯•
```bash
python src/6-agents.py
# é€‰æ‹©æ¨¡å¼ 3 â†’ è§‚å¯Ÿ architect æ‰§è¡Œåæ˜¯å¦æœ‰è¶Šæƒæ ¡éªŒæ—¥å¿—
# å¦‚æœ‰è¿è§„ â†’ æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨å›æ»š
```

### Feature 4 æµ‹è¯•
```bash
python src/6-agents.py
# é€‰æ‹©æ¨¡å¼ 4 â†’ è¾“å…¥: @dev task1.md
# æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º "ğŸ“„ @developer: ä» task1.md è¯»å–ä»»åŠ¡æè¿°"
```
